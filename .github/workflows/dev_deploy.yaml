name: Dev Deploy

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  deploy-cdk:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Load Config
        id: load_config
        uses: ./cdk/.github/actions/load-yaml-action
        with:
          file_path: cdk/config/development.yaml
          keys_to_load: "github_actions, aws, app_name, env"

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: ${{ steps.load_config.outputs['github_actions.aws_deploy_role'] }}
          aws-region: ${{ steps.load_config.outputs['github_actions.aws_region'] }}

      - name: Copy WebArena AMI to us-east-1
        id: copy-ami
        shell: bash
        run: |
          EXISTING=$(aws ec2 describe-images --owners self \
            --filters "Name=name,Values=webarena-with-configurable-map-backend" \
            --query 'Images[0].ImageId' --output text --region us-east-1)
          if [ "$EXISTING" != "None" ] && [ -n "$EXISTING" ]; then
            echo "AMI already exists in us-east-1: $EXISTING"
            AMI_ID=$EXISTING
          else
            echo "Copying AMI from us-east-2 to us-east-1..."
            AMI_ID=$(aws ec2 copy-image \
              --source-region us-east-2 \
              --source-image-id ami-08a862bf98e3bd7aa \
              --name webarena-with-configurable-map-backend \
              --region us-east-1 \
              --query ImageId --output text)
            echo "Waiting for AMI $AMI_ID to become available..."
            aws ec2 wait image-available --image-ids "$AMI_ID" --region us-east-1
          fi
          echo "ami_id=$AMI_ID" >> "$GITHUB_OUTPUT"

      - name: Install AWS CDK
        run: |
          pip install -r cdk/cdk/requirements.txt
          npm install -g aws-cdk

      - name: Verify if stack exists
        id: stack-exists-check
        run: |
          if ! aws cloudformation describe-stacks \
            --region ${{ steps.load_config.outputs['aws.region'] }} \
            --stack-name ${{ steps.load_config.outputs['app_name'] }}-${{ steps.load_config.outputs['env'] }}; then
            echo "stack_exists=0" >> "$GITHUB_OUTPUT"
          else
            echo "stack_exists=1" >> "$GITHUB_OUTPUT"
          fi

      - name: Run CDK Deploy
        run: |
          cd cdk/cdk
          cdk deploy --require-approval never \
            -c ami_id=${{ steps.copy-ami.outputs.ami_id }} \
            -c deploy_env=${{ steps.load_config.outputs['env'] }}
