name: Dev Deploy

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  deploy-cdk:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Load Config
        id: load_config
        uses: ./cdk/.github/actions/load-yaml-action
        with:
          file_path: cdk/config/development.yaml
          keys_to_load: "github_actions, aws, app_name, env"

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: ${{ steps.load_config.outputs['github_actions.aws_deploy_role'] }}
          aws-region: ${{ steps.load_config.outputs['github_actions.aws_region'] }}

      - name: Install AWS CDK
        run: |
          pip install -r cdk/cdk/requirements.txt
          npm install -g aws-cdk

      - name: Run CDK Deploy
        run: |
          cd cdk/cdk
          cdk deploy --require-approval never \
            -c deploy_env=${{ steps.load_config.outputs['env'] }}
