name: Development Deployment
on:
  workflow_dispatch:
  # We run the deployment on any push to main
  push:
    branches:
      - main
jobs:
  deploy-cdk:
    runs-on: ubuntu-latest
    outputs:
      ami_id: ${{ steps.copy-ami.outputs.ami_id }}
    permissions:
      id-token: write # This is required for requesting the JWT
      contents: read # This is required for actions/checkout
    steps:
      # Checkout the code first
      - name: Checkout Code
        uses: actions/checkout@v2
      # We read the yaml configuration file for development
      - name: Load Config
        id: load_config
        uses: ./.github/actions/load-yaml-action
        with:
          file_path: config/development.yaml
          keys_to_load: "github_actions, aws, app_name, env"
      # Configure AWS credentials for CDK diff and deploy
      - name: Load AWS Account
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: ${{ steps.load_config.outputs['github_actions.aws_deploy_role'] }}
          aws-region: ${{ steps.load_config.outputs['github_actions.aws_region'] }}
      # Copy WebArena AMI from us-east-2 to us-east-1 if not already present
      - name: Copy WebArena AMI to us-east-1
        id: copy-ami
        shell: bash
        run: |
          EXISTING=$(aws ec2 describe-images --owners self \
            --filters "Name=name,Values=webarena-with-configurable-map-backend" \
            --query 'Images[0].ImageId' --output text --region us-east-1)
          if [ "$EXISTING" != "None" ] && [ -n "$EXISTING" ]; then
            echo "AMI already exists in us-east-1: $EXISTING"
            AMI_ID=$EXISTING
          else
            echo "Copying AMI from us-east-2 to us-east-1..."
            AMI_ID=$(aws ec2 copy-image \
              --source-region us-east-2 \
              --source-image-id ami-08a862bf98e3bd7aa \
              --name webarena-with-configurable-map-backend \
              --region us-east-1 \
              --query ImageId --output text)
            echo "Waiting for AMI $AMI_ID to become available..."
            aws ec2 wait image-available --image-ids "$AMI_ID" --region us-east-1
          fi
          echo "ami_id=$AMI_ID" >> "$GITHUB_OUTPUT"
      ## We install CDK
      - name: Install AWS CDK
        run: |
          pip install -r ${PWD}/cdk/requirements.txt
          npm install -g aws-cdk
      - name: Verify If stack exists
        id: stack-exists-check
        env:
          REGION: ${{ steps.load_config.outputs['aws.region'] }}
          STACK_NAME: ${{ steps.load_config.outputs['app_name'] }}-${{ steps.load_config.outputs['env']}}
        run: |
          if ! aws cloudformation describe-stacks --region ${{ env.REGION }} --stack-name ${{ env.STACK_NAME }} ; then
            echo -e "Stack does not exist - no need to run drift detection"
            echo "stack_exists=0" >> "$GITHUB_OUTPUT"
          else
            echo -e "Stack exists - proceed with drift detection"
            echo "stack_exists=1" >> "$GITHUB_OUTPUT"
          fi
      - name: Detect Drift on Development
        id: drift_detect
        if: ${{ steps.stack-exists-check.outputs.stack_exists == 1 }}
        uses: TRI-ML/cdk-drift-check@v0.0.4
        env:
          APP_NAME: ${{ steps.load_config.outputs['app_name'] }}
          ENVIRONMENT: ${{ steps.load_config.outputs['env'] }}
        with:
          stack_name: "${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}"
      - name: Show Drift
        shell: bash
        if: steps.drift_detect.outputs.result == 'DRIFTED'
        run: |
          echo '${{ steps.drift_detect.outputs.details }}' | python3 -mjson.tool
      - name: Run CDK Deploy
        run: |
          cd ./cdk
          cdk deploy --require-approval never \
            -c ami_id=${{ steps.copy-ami.outputs.ami_id }} \
            -c deploy_env=${{ steps.load_config.outputs['env'] }}
